#!/bin/sh -e

# Prints a quote to stdout once per day. 

date_file="$HOME/.local/share/daily-msg/run-date"
slowtype="$HOME/.local/scripts/slowtype"
log_file=$(find "$HOME/documents/log" -print0 | sort -z \
  | tail -zn 1 | tr -d '\0')
stty_original=$(stty -g)

cleanup () { 
  rm -f "$temp_file"
  stty $stty_original
}
cleanup_err () { 
  date -I >"$date_file"
  cleanup
  exit 1
}
trap cleanup_err SIGINT

stty -echo

# Load the last time this program was run, and store the current date.
mkdir -p "$(dirname "$date_file")"
if [ -e "$date_file" ]; then 
  last_date=$(cat "$date_file")
else
  last_date="never"
fi

# Exit if we've already printed a quote today or it's not 6:30 AM yet.
if [ "$(date -I)" = "$last_date" ] \
    || [ "$(date '+%s')" -lt "$(date -d '06:30 Today' '+%s')" ]; then
  cleanup
  exit
fi
date -I >"$date_file"

# Print the quote.

"$slowtype" 30 2 <<EOF 
Logbook Data Found.
Replaying Entry $(basename "$log_file" '.md')...
EOF
cat "$log_file" | less

cleanup
